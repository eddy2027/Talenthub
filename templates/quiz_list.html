{% extends "base.html" %}
{% block title %}Quizzes · {{ course.title }}{% endblock %}

{% block content %}
<h1 style="margin-bottom:16px;">{{ course.title }} · Quizzes</h1>

{% if quizzes %}
  <table class="table" style="width:100%;">
    <thead>
      <tr>
        <th style="text-align:left;padding:8px;">Quiz</th>
        <th style="text-align:left;padding:8px;">Pass</th>
        <th style="text-align:left;padding:8px;">Attempts</th>
        <th style="text-align:left;padding:8px;">Last result</th>
        <th style="text-align:left;padding:8px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for q in quizzes %}
      <tr>
        <td style="padding:8px;">{{ q.title }}</td>
        <td style="padding:8px;">{{ q.pass_score }}%</td>
        <td style="padding:8px;">
          {{ q.used_attempts }}/{{ q.allowed_attempts }}
          {% if q.attempts_left == 0 %}
            <span class="secondary">· no attempts left</span>
          {% endif %}
        </td>
        <td style="padding:8px;">
          {% if q.last_score is not None %}
            {{ q.last_score }}% ·
            {% if q.last_passed %}✅ Passed{% else %}❌ Failed{% endif %}
          {% else %}
            <span class="secondary">No attempts yet</span>
          {% endif %}
        </td>
        <td style="padding:8px; white-space:nowrap;">
          {% if q.attempts_left > 0 %}
            <a class="btn btn-primary" href="{% url 'quiz_take' q.id %}">Take quiz</a>
          {% else %}
            <button class="btn" disabled>Take quiz</button>
          {% endif %}

          {# Controles de gestión: SOLO si venimos con ?manage=1 y el usuario es Admin/superuser #}
          {% with role=request.user.profile.role|default:'LEARNER' %}
            {% if manage_mode %}
              {% if request.user.is_superuser or role == 'ADMIN' %}
                <a class="btn" style="margin-left:8px;" href="{% url 'quiz_add_question' q.id %}">Add question</a>
                <a class="btn" style="margin-left:8px;" href="{% url 'question_list' q.id %}">Manage questions</a>
              {% endif %}
            {% endif %}
          {% endwith %}
        </td>
      </tr>

      {% if q.recent_attempts %}
      <tr>
        <td colspan="5" style="padding:8px 8px 12px;">
          <div class="secondary" style="margin-bottom:6px;">Recent attempts</div>
          <table class="table" style="width:100%;">
            <thead>
              <tr>
                <th style="text-align:left;padding:6px;">When</th>
                <th style="text-align:left;padding:6px;">Score</th>
                <th style="text-align:left;padding:6px;">Passed</th>
                <th style="text-align:left;padding:6px;">Open</th>
              </tr>
            </thead>
            <tbody>
              {% for a in q.recent_attempts %}
              <tr>
                <td style="padding:6px;">{{ a.finished_at|default:a.started_at }}</td>
                <td style="padding:6px;">{{ a.score|default:"0" }}%</td>
                <td style="padding:6px;">{% if a.passed %}Yes{% else %}No{% endif %}</td>
                <td style="padding:6px;">
                  <a class="btn" href="{% url 'quiz_result' q.id a.id %}">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </td>
      </tr>
      {% endif %}

      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="secondary">This course has no quizzes yet.</p>
{% endif %}

<p style="margin-top:16px;">
  <a href="{% url 'course_view' course.id %}">← Back to course</a>
</p>
{% endblock %}
